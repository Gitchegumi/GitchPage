="background: #f1f5f9; color: #475569;">
                                        <th style="padding: 3px; border: 1px solid #e2e8f0; width: 90px; text-align: left; font-weight: bold;">Debt Name</th>
                                        ${lastResult.timeline.slice(0, 6).map(step => `<th style="padding: 3px; border: 1px solid #e2e8f0; text-align: center; min-width: 110px;">${step.date}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${lastResult.debtNames.map(name => `
                                        <tr style="page-break-inside: avoid;">
                                            <td style="padding: 3px; border: 1px solid #e2e8f0; font-weight: bold; background: #f8fafc; color: #1e293b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${name}</td>
                                            ${lastResult.timeline.slice(0, 6).map((step, monthIdx) => {
                                                const start = step.startingBalances[name] || 0;
                                                const bal = step.balances[name];
                                                const paid = step.payments[name] || 0;
                                                const planned = step.plannedPayments[name] || 0;
                                                const interest = step.interests[name] || 0;
                                                const key = `${name}::${monthIdx}`;
                                                const isMarkedPaid = payments[key] === true;
                                                const customAmount = customPayments[key] || 0;
                                                const isFullyPaid = bal <= 0.01 && start > 0;
                                                
                                                let bgStyle = '';
                                                if (isFullyPaid) bgStyle = 'background: #ecfdf5;';
                                                else if (customAmount > 0) bgStyle = 'background: #eff6ff;';
                                                
                                                const paymentBadge = isMarkedPaid ? '<span style="color: #059669; font-weight: bold;">âœ“</span> ' : '';
                                                const customBadge = customAmount > 0 ? '<span style="color: #3b82f6; font-size: 6pt;">[CUSTOM]</span><br>' : '';
                                                
                                                return `<td style="padding: 3px; border: 1px solid #e2e8f0; text-align: center; vertical-align: top; ${bgStyle} color: #64748b;">
                                                    <div>${customBadge}${paymentBadge}<span style="${bal <= 0.01 ? 'color: #059669; font-weight: bold;' : ''}">${bal <= 0.01 ? 'PAID' : '$' + fmt(bal)}</span><br>
                                                    ${paid > 0.01 ? `<span style="color: #10b981; font-size: 6pt;">Paid: $${fmt(paid)}</span><br>` : ''}
                                                    ${planned > 0.01 && paid !== planned ? `<span style="color: #94a3b8; font-size: 5pt; text-decoration: line-through;">Plan: $${fmt(planned)}</span><br>` : ''}
                                                    ${interest > 0.01 ? `<span style="color: #f43f5e; font-size: 5pt;">Int: $${fmt(interest)}</span>` : ''}
                                                </td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #e2e8f0; font-size: 7pt; color: #94a3b8; text-align: center;">
                        Generated by DebtPipe - gitchegumi.com/debtpipe | This report reflects actual payment tracking data
                    </div>
                </div>
            `;

            const opt = {
                margin: 10,
                filename: 'DebtPipe_Payment_Tracker_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    letterRendering: true,
                    scrollY: 0,
                    scrollX: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(html).save();
        }
    </script>
</body>
</html>
